# yaml-language-server: $schema=bundle_config_schema.json
bundle:
  name: techsummit-cvops

workspace:
  host: https://adb-984752964297111.11.azuredatabricks.net/

resources:

  pipelines:
    # Our DLT pipeline
    cvops_dlt_pipeline:
      name: "[${bundle.environment}] Tech Summit CVOps Pipeline"
      catalog: "techsummit_cvops_${bundle.environment}"
      target: pcb
      libraries:
        - file:
            path: ./etl/ingest.py
        - file:
            path: ./etl/preprocess.py
      channel: preview
      configuration:
        "bundle.file_path": "/Workspace/${workspace.file_path}"
        "pipelines.catalog": "techsummit_cvops_${bundle.environment}"
        "pipelines.schema": "pcb"
      serverless: true

  jobs:
    # A two-task Databricks Workflow - dlt + notebook report
    techsummit_cvops_training:
      name: "[${bundle.environment}] Tech Summit CVOps - Training pipeline"
      tasks:
        - task_key: cvops_dlt_pipeline
          pipeline_task:
            pipeline_id: ${resources.pipelines.cvops_dlt_pipeline.id}
#        - task_key: "${bundle.environment}_medium_notebook_report"
#          depends_on:
#            - task_key: dlt_medium_pipeline
#          notebook_task:
#            base_parameters:
#              dbname: "medium_post_report_${bundle.environment}"
#            notebook_path: ./train/train_model.py
#          new_cluster:
#            spark_version: 13.1.x-scala2.12
#            num_workers: 1
#            node_type_id: i3.xlarge

environments:
  development:
    default: true
    resources:
      pipelines:
        cvops_dlt_pipeline:
          development: true

  preproduction: # This environment is when deploying test runs from a pull request on GitHub.
    workspace:
      host: https://adb-984752964297111.11.azuredatabricks.net/
    resources:
      pipelines:
        cvops_dlt_pipeline:
          development: true
          permissions:
            - level: CAN_VIEW
              group_name: users      

  production:
    workspace:
      host: https://adb-984752964297111.11.azuredatabricks.net/
    resources:
      pipelines:
        cvops_dlt_pipeline:
          permissions:
          - level: CAN_VIEW
            group_name: users
          development: false
          # photon: true
          # clusters:
          #   - autoscale:
          #       min_workers: 2
          #       max_workers: 8
