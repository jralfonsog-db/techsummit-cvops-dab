# yaml-language-server: $schema=bundle_config_schema.json
bundle:
  name: techsummit-cvops

workspace:
  host: https://adb-984752964297111.11.azuredatabricks.net/

resources:
  jobs:
    # A three-task Databricks Workflow (all notebooks) - ingestion + preprocessing + training
    techsummit_cvops_training:
      name: "[${bundle.environment}] Tech Summit CVOps - Training pipeline"
      job_clusters:
        - job_cluster_key: light-cpu-cluster
          new_cluster:
            spark_version: 13.3.x-cpu-scala2.12
            node_type_id: Standard_DS3_v2
            num_workers: 2
        - job_cluster_key: light-gpu-cluster
          new_cluster:
            spark_version: 13.3.x-gpu-ml-scala2.12
            node_type_id: Standard_NC6s_v3
            spark_conf:
              spark.master: local[*, 4]
              spark.databricks.cluster.profile: singleNode
              spark.databricks.dataLineage.enabled: 'true'
              spark.databricks.delta.preview.enabled: 'true'
      tasks:
        - task_key: "${bundle.environment}_ingestion"
          job_cluster_key: light-cpu-cluster
          notebook_task:
            base_parameters:
              catalog: "techsummit_cvops_${bundle.environment}"
              schema: "pcb"
            notebook_path: ./etl/ingestion.py
        - task_key: "${bundle.environment}_preprocessing"
          depends_on:
            - task_key: "${bundle.environment}_ingestion"
          job_cluster_key: light-cpu-cluster
          notebook_task:
            base_parameters:
              catalog: "techsummit_cvops_${bundle.environment}"
              schema: "pcb"
            notebook_path: ./etl/preprocessing.py
        - task_key: "${bundle.environment}_train_model"
          depends_on:
            - task_key: "${bundle.environment}_preprocessing"
          job_cluster_key: light-gpu-cluster
          notebook_task:
            base_parameters:
              catalog: "techsummit_cvops_${bundle.environment}"
              schema: "pcb"
            notebook_path: ./train/train_model.py


environments:
  development:
    default: true

  preproduction: # This environment is when deploying test runs from a pull request on GitHub.
    workspace:
      host: https://adb-984752964297111.11.azuredatabricks.net/
    resources:
      pipelines:
        cvops_dlt_pipeline:
          development: true
          permissions:
            - level: CAN_VIEW
              group_name: users      

  production:
    workspace:
      host: https://adb-984752964297111.11.azuredatabricks.net/
    resources:
      pipelines:
        cvops_dlt_pipeline:
          permissions:
          - level: CAN_VIEW
            group_name: users
          development: false
          # photon: true
          # clusters:
          #   - autoscale:
          #       min_workers: 2
          #       max_workers: 8
